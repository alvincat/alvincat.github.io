<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>多线程的特性和同步方法 - Alvincat&#39;s Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="alvincat" /><meta name="description" content="本文总结多线程的特性和同步方法。
" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.138.0 with theme even" />


<link rel="canonical" href="http://localhost:1313/post/linux/apue/thread_synchronization/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f5a694fa8a6b263f05f575c19a1e180f4c9dd0ee7515e64585961f31d756a263.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:url" content="http://localhost:1313/post/linux/apue/thread_synchronization/">
  <meta property="og:site_name" content="Alvincat&#39;s Blog">
  <meta property="og:title" content="多线程的特性和同步方法">
  <meta property="og:description" content="本文总结多线程的特性和同步方法。">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-12-05T11:29:06+08:00">
    <meta property="article:modified_time" content="2024-12-05T11:29:06+08:00">
    <meta property="article:tag" content="APUE">
    <meta property="article:tag" content="多线程">
    <meta property="article:tag" content="线程同步">

  <meta itemprop="name" content="多线程的特性和同步方法">
  <meta itemprop="description" content="本文总结多线程的特性和同步方法。">
  <meta itemprop="datePublished" content="2024-12-05T11:29:06+08:00">
  <meta itemprop="dateModified" content="2024-12-05T11:29:06+08:00">
  <meta itemprop="wordCount" content="1941">
  <meta itemprop="keywords" content="APUE,多线程,线程同步">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="多线程的特性和同步方法">
  <meta name="twitter:description" content="本文总结多线程的特性和同步方法。">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Alvincat&#39;s Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/search/">
        <li class="mobile-menu-item">搜索</li>
      </a><a href="/contents/">
        <li class="mobile-menu-item">目录</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Alvincat&#39;s Blog</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/search/">搜索</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/contents/">目录</a>
      </li>
  </ul>
</nav>

    </header><main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">多线程的特性和同步方法</h1>

      <div class="post-meta">
        <span class="post-time"> 2024-12-05 </span>
        <div class="post-category">
            <a href="/categories/linux/"> Linux </a>
            </div>
          <span class="more-meta"> 约 1941 字 </span>
          <span class="more-meta"> 预计阅读 4 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#多线程">多线程</a></li>
    <li><a href="#1-线程数据">1 线程数据</a>
      <ul>
        <li><a href="#11-线程私有数据">1.1 线程私有数据</a></li>
        <li><a href="#12-线程共享数据">1.2 线程共享数据</a></li>
      </ul>
    </li>
    <li><a href="#1-线程同步方法">1 线程同步方法</a>
      <ul>
        <li><a href="#11-原子操作">1.1 原子操作</a></li>
        <li><a href="#12-自旋锁spinklock">1.2 自旋锁(spinklock)</a>
          <ul>
            <li><a href="#121-pthread自旋锁接口">1.2.1 pthread自旋锁接口</a></li>
            <li><a href="#122-pthread_spin_lock实现">1.2.2 pthread_spin_lock实现</a></li>
            <li><a href="#122-pthread_spin_unlock实现">1.2.2 pthread_spin_unlock实现</a></li>
          </ul>
        </li>
        <li><a href="#13-互斥量mutex">1.3 互斥量(mutex)</a>
          <ul>
            <li><a href="#131-pthread-mutex接口">1.3.1 pthread mutex接口</a></li>
            <li><a href="#132-pthread_mutex结构">1.3.2 pthread_mutex结构</a></li>
          </ul>
        </li>
        <li><a href="#14-读写锁rw_lock">1.4 读写锁(rw_lock)</a>
          <ul>
            <li><a href="#141-读写锁特性">1.4.1 读写锁特性</a></li>
            <li><a href="#142-读写锁接口">1.4.2 读写锁接口</a></li>
          </ul>
        </li>
        <li><a href="#15-条件变量condition-variable">1.5 条件变量(condition variable)</a>
          <ul>
            <li><a href="#151-条件变量相关接口">1.5.1 条件变量相关接口</a></li>
            <li><a href="#152-条件变量实例">1.5.2 条件变量实例</a></li>
          </ul>
        </li>
        <li><a href="#16-二进制信号量">1.6 二进制信号量</a></li>
      </ul>
    </li>
    <li><a href="#2-死锁">2 死锁</a>
      <ul>
        <li><a href="#21-死锁的产生">2.1 死锁的产生</a></li>
        <li><a href="#22-死锁检测">2.2 死锁检测</a></li>
        <li><a href="#22-常见死锁">2.2 常见死锁</a></li>
      </ul>
    </li>
    <li><a href="#3-线程安全函数">3 线程安全函数</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>本文总结多线程的特性和同步方法。</p>
<h1 id="多线程">多线程</h1>
<p>多线程的复杂性来源：</p>
<ol>
<li>CPU任务可抢占</li>
<li>多核并发</li>
<li>线程让渡</li>
</ol>
<h1 id="1-线程数据">1 线程数据</h1>
<h2 id="11-线程私有数据">1.1 线程私有数据</h2>
<p>线程有如下私有数据：</p>
<ul>
<li>线程ID，线程ID在进程内部唯一。</li>
<li>一组寄存器</li>
<li>栈</li>
<li>调度优先级和调度策略</li>
<li>信号屏蔽字</li>
<li>errno变量</li>
<li>线程私有数据</li>
</ul>
<h2 id="12-线程共享数据">1.2 线程共享数据</h2>
<p>一个进程中的所有信息对该进程中的所有线程都是共享的。包含如下信息：</p>
<ul>
<li>
<p>可执行程序的代码</p>
</li>
<li>
<p>程序的全局变量</p>
</li>
<li>
<p>堆内存</p>
</li>
<li>
<p>栈</p>
</li>
<li>
<p>文件描述符</p>
</li>
</ul>
<h1 id="1-线程同步方法">1 线程同步方法</h1>
<p>原子操作相关的接口由GCC自身提供，使用时无需包含其他头文件。pthread相关接口由glibc提供，使用时需要包含pthread.h头文件。</p>
<h2 id="11-原子操作">1.1 原子操作</h2>
<p>原子操作主要用于对整数进行简单的取值、加减、交换操作。由GCC提供的原子操作：</p>
<ol>
<li>n++类</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">type</span> <span class="nf">__sync_fetch_and_add</span><span class="p">(</span><span class="n">type</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">type</span> <span class="n">value</span><span class="p">,</span> <span class="p">...);</span> <span class="c1">// m+n
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">type</span> <span class="nf">__sync_fetch_and_sub</span><span class="p">(</span><span class="n">type</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">type</span> <span class="n">value</span><span class="p">,</span> <span class="p">...);</span> <span class="c1">// m-n
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">type</span> <span class="nf">__sync_fetch_and_or</span><span class="p">(</span><span class="n">type</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">type</span> <span class="n">value</span><span class="p">,</span> <span class="p">...);</span>  <span class="c1">// m|n
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">type</span> <span class="nf">__sync_fetch_and_and</span><span class="p">(</span><span class="n">type</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">type</span> <span class="n">value</span><span class="p">,</span> <span class="p">...);</span> <span class="c1">// m&amp;n
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">type</span> <span class="nf">__sync_fetch_and_xor</span><span class="p">(</span><span class="n">type</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">type</span> <span class="n">value</span><span class="p">,</span> <span class="p">...);</span> <span class="c1">// m^n
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">type</span> <span class="nf">__sync_fetch_and_nand</span><span class="p">(</span><span class="n">type</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">type</span> <span class="n">value</span><span class="p">,</span> <span class="p">...);</span> <span class="c1">// (~m)&amp;n
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cm">/* 对应的伪代码 */</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span> <span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span> <span class="o">*</span><span class="n">ptr</span> <span class="n">op</span><span class="o">=</span> <span class="n">value</span><span class="p">;</span> <span class="k">return</span> <span class="n">tmp</span><span class="p">;</span> <span class="p">}{</span> <span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">tmp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">value</span><span class="p">;</span> <span class="k">return</span> <span class="n">tmp</span><span class="p">;</span> <span class="p">}</span>   <span class="c1">// nand
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>++n类</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">type</span> <span class="nf">__sync_add_and_fetch</span><span class="p">(</span><span class="n">type</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">type</span> <span class="n">value</span><span class="p">,</span> <span class="p">...);</span> <span class="c1">// m+n
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">type</span> <span class="nf">__sync_sub_and_fetch</span><span class="p">(</span><span class="n">type</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">type</span> <span class="n">value</span><span class="p">,</span> <span class="p">...);</span> <span class="c1">// m-n
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">type</span> <span class="nf">__sync_or_and_fetch</span><span class="p">(</span><span class="n">type</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">type</span> <span class="n">value</span><span class="p">,</span> <span class="p">...);</span> <span class="c1">// m|n
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">type</span> <span class="nf">__sync_and_and_fetch</span><span class="p">(</span><span class="n">type</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">type</span> <span class="n">value</span><span class="p">,</span> <span class="p">...);</span> <span class="c1">// m&amp;n
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">type</span> <span class="nf">__sync_xor_and_fetch</span><span class="p">(</span><span class="n">type</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">type</span> <span class="n">value</span><span class="p">,</span> <span class="p">...);</span> <span class="c1">// m^n
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">type</span> <span class="nf">__sync_nand_and_fetch</span><span class="p">(</span><span class="n">type</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">type</span> <span class="n">value</span><span class="p">,</span> <span class="p">...);</span> <span class="c1">// (~m)&amp;n
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cm">/* 对应的伪代码 */</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span> <span class="o">*</span><span class="n">ptr</span> <span class="n">op</span><span class="o">=</span> <span class="n">value</span><span class="p">;</span> <span class="k">return</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span> <span class="p">}{</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="o">~*</span><span class="n">ptr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">value</span><span class="p">;</span> <span class="k">return</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span> <span class="p">}</span> <span class="c1">// nand
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>3.CAS类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">bool</span> <span class="nf">__sync_bool_compare_and_swap</span> <span class="p">(</span><span class="n">type</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">type</span> <span class="n">oldval</span><span class="p">,</span> <span class="n">type</span> <span class="n">newval</span><span class="p">,</span> <span class="p">...);</span>
</span></span><span class="line"><span class="cl"><span class="n">type</span> <span class="nf">__sync_val_compare_and_swap</span> <span class="p">(</span><span class="n">type</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">type</span> <span class="n">oldval</span><span class="p">,</span> <span class="n">type</span> <span class="n">newval</span><span class="p">,</span> <span class="p">...);</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 对应的伪代码 */</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">==</span> <span class="n">oldval</span><span class="p">)</span> <span class="p">{</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">newval</span><span class="p">;</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span> <span class="p">}</span> <span class="p">}{</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">==</span> <span class="n">oldval</span><span class="p">)</span> <span class="p">{</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">newval</span><span class="p">;</span> <span class="p">}</span> <span class="k">return</span> <span class="n">oldval</span><span class="p">;</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="12-自旋锁spinklock">1.2 自旋锁(spinklock)</h2>
<p>自旋锁使用场景：执行时间短的任务。</p>
<p>等待自旋锁的过程中，不会让渡CPU资源，盲等。</p>
<h3 id="121-pthread自旋锁接口">1.2.1 pthread自旋锁接口</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="nf">pthread_spin_init</span><span class="p">(</span><span class="kt">pthread_spinlock_t</span><span class="o">*</span> <span class="n">lock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pshared</span><span class="p">);</span> <span class="c1">// init spink lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">pthread_spin_destroy</span><span class="p">(</span><span class="kt">pthread_spinlock_t</span><span class="o">*</span> <span class="n">lock</span><span class="p">);</span> <span class="c1">// destroy spin lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">pthread_spin_lock</span><span class="p">(</span><span class="kt">pthread_spinlock_t</span><span class="o">*</span> <span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">pthread_spin_unlock</span><span class="p">(</span><span class="kt">pthread_spinlock_t</span><span class="o">*</span> <span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">pthread_spin_trylock</span><span class="p">(</span><span class="kt">pthread_spinlock_t</span><span class="o">*</span> <span class="n">lock</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="122-pthread_spin_lock实现">1.2.2 pthread_spin_lock实现</h3>
<p>以x86系统为例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">pthread_spin_lock</span> <span class="p">(</span> <span class="kt">pthread_spinlock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">asm</span> <span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="s">&#34;1:</span><span class="se">\t</span><span class="s">&#34;</span> <span class="n">LOCK_PREFIX</span> <span class="s">&#34;decl %0</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="s">&#34;jne 2f</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="s">&#34;.subsection 1</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="s">&#34;.align 16</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="s">&#34;2:</span><span class="se">\t</span><span class="s">rep; nop</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="s">&#34;cmpl $0, %0</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="s">&#34;jg 1b</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="s">&#34;jmp 2b</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="s">&#34;.previous&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="o">:</span> <span class="s">&#34;=m&#34;</span> <span class="p">(</span><span class="o">*</span><span class="n">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="o">:</span> <span class="s">&#34;m&#34;</span> <span class="p">(</span><span class="o">*</span><span class="n">lock</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="122-pthread_spin_unlock实现">1.2.2 pthread_spin_unlock实现</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nasm" data-lang="nasm"><span class="line"><span class="cl">    <span class="nf">.globl</span>    <span class="nv">pthread_spin_unlock</span>
</span></span><span class="line"><span class="cl">    <span class="nf">.type</span>    <span class="nv">pthread_spin_unlock</span><span class="p">,</span><span class="err">@</span><span class="nv">function</span>
</span></span><span class="line"><span class="cl">    <span class="nf">.align</span>    <span class="mi">16</span>
</span></span><span class="line"><span class="cl"><span class="nl">pthread_spin_unlock:</span>
</span></span><span class="line"><span class="cl">    <span class="nf">movl</span>    <span class="mi">4</span><span class="p">(</span><span class="o">%</span><span class="nb">esp</span><span class="p">),</span> <span class="o">%</span><span class="nb">eax</span>
</span></span><span class="line"><span class="cl">    <span class="nf">movl</span>    <span class="kc">$</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="o">%</span><span class="nb">eax</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">xorl</span>    <span class="o">%</span><span class="nb">eax</span><span class="p">,</span> <span class="o">%</span><span class="nb">eax</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ret</span>
</span></span><span class="line"><span class="cl">    <span class="nf">.size</span>    <span class="nv">pthread_spin_unlock</span><span class="p">,</span><span class="nv">.</span><span class="o">-</span><span class="nv">pthread_spin_unlock</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="err">/*</span> <span class="nf">The</span> <span class="nv">implementation</span> <span class="nv">of</span> <span class="nv">pthread_spin_init</span> <span class="nv">is</span> <span class="nv">identical.</span>  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">    <span class="nf">.globl</span>    <span class="nv">pthread_spin_init</span>
</span></span><span class="line"><span class="cl"><span class="nf">pthread_spin_init</span> <span class="err">=</span> <span class="nv">pthread_spin_unlock</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="13-互斥量mutex">1.3 互斥量(mutex)</h2>
<p>对互斥量进行加锁以后，任何其它试图再次对互斥量加锁的线程都会被阻塞，直到当前你线程释放该互斥锁。如果释放互斥锁时有一个以上的线程阻塞，那么所有阻塞在该互斥量上的线程都会变为可运行状态。但是只有第一个可运行状态的线程可以获取互斥锁而得以继续运行，其他线程仍然需要继续等待。</p>
<h3 id="131-pthread-mutex接口">1.3.1 pthread mutex接口</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// pthread_mutex_t结构定义：
</span></span></span><span class="line"><span class="cl"><span class="c1">// nptl\sysdeps\unix\sysv\linux\x86_64\bits\pthreadtypes.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="nf">pthread_mutex_init</span><span class="p">(</span><span class="kt">pthread_mutex_t</span><span class="o">*</span> <span class="n">mutex</span><span class="p">,</span> <span class="k">const</span> <span class="kt">pthread_mutexattr_t</span><span class="o">*</span> <span class="n">attr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">pthread_mutex_destroy</span><span class="p">(</span><span class="kt">pthread_mutex_t</span><span class="o">*</span> <span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">pthread_mutex_lock</span><span class="p">(</span><span class="kt">pthread_mutex_t</span><span class="o">*</span> <span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">pthread_mutex_trylock</span><span class="p">(</span><span class="kt">pthread_mutex_t</span><span class="o">*</span> <span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">phtread_mutex_unlock</span><span class="p">(</span><span class="kt">pthread_mutex_t</span><span class="o">*</span> <span class="n">mutex</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="132-pthread_mutex结构">1.3.2 pthread_mutex结构</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// x86_64结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">typedef</span> <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">__pthread_mutex_s</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">__lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">__owner</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__nusers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">__kind</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">__spins</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">__pthread_list_t</span> <span class="n">__list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp"># define __PTHREAD_MUTEX_HAVE_PREV    1
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="p">}</span> <span class="n">__data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">__size</span><span class="p">[</span><span class="n">__SIZEOF_PTHREAD_MUTEX_T</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="kt">int</span> <span class="n">__align</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kt">pthread_mutex_t</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="14-读写锁rw_lock">1.4 读写锁(rw_lock)</h2>
<h3 id="141-读写锁特性">1.4.1 读写锁特性</h3>
<p>读写锁可以有3种状态：读模式下加锁状态，写模式下加锁状态和不加锁状态。一次只有一个线程可以占有写模式的读写锁，但是多个线程可以同时占有读模式的读写锁。</p>
<p>当读写锁是写加锁状态时，在这个锁被解锁前，所有试图对这个锁加锁的线程都会被阻塞。当读写锁在读加锁状态时，所有试图以读模式对它进行加锁的线程都可以的到访问权。但是任何希望以写模式对此锁进行加锁的线程都会阻塞，直到所有的线程释放它们的读锁为止。该模式为读锁优先模式，存在申请写锁的线程饥饿问题。</p>
<p><strong>优化方案</strong>：当读写锁处于读模式锁住的状态，而这时有一个线程试图以写模式获取锁时，读写锁通常会阻塞随后的读模式锁请求。这样可以避免读模式锁长期占用，写模式锁一直等待的问题。</p>
<h3 id="142-读写锁接口">1.4.2 读写锁接口</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="nf">pthread_rwlock_init</span><span class="p">(</span><span class="kt">phread_rwlock_t</span><span class="o">*</span> <span class="n">rwlock</span><span class="p">,</span> <span class="kt">pthread_rwlockattr_t</span><span class="o">*</span> <span class="n">attr</span><span class="p">);</span> <span class="c1">//init
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">pthread_rwlock_destroy</span><span class="p">(</span><span class="kt">pthread_rwlok_t</span><span class="o">*</span> <span class="n">rwlock</span><span class="p">);</span> <span class="c1">// destroy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">pthread_rwlock_rdlock</span><span class="p">(</span><span class="kt">pthread_rwlock_t</span><span class="o">*</span> <span class="n">rwlock</span><span class="p">);</span> <span class="c1">// set read lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">pthread_rwlock_wrlock</span><span class="p">(</span><span class="kt">pthread_rwlock_t</span><span class="o">*</span> <span class="n">rwlock</span><span class="p">);</span> <span class="c1">// set write lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">pthread_rwlock_unlock</span><span class="p">(</span><span class="kt">pthread_rwlock_t</span><span class="o">*</span> <span class="n">unlock</span><span class="p">);</span> <span class="c1">// unlock read/write lock
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="15-条件变量condition-variable">1.5 条件变量(condition variable)</h2>
<h3 id="151-条件变量相关接口">1.5.1 条件变量相关接口</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">pthread_cond_init</span><span class="p">(</span><span class="kt">pthread_cond_t</span><span class="o">*</span> <span class="n">cond</span><span class="p">,</span> <span class="k">const</span> <span class="kt">pthread_condattr_t</span><span class="o">*</span> <span class="n">attr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">pthread_cond_destroy</span><span class="p">(</span><span class="kt">pthread_cond_t</span><span class="o">*</span> <span class="n">cond</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">pthread_cond_wait</span><span class="p">(</span><span class="kt">pthread_cond_t</span><span class="o">*</span> <span class="n">cond</span><span class="p">,</span> <span class="kt">pthread_mutex_t</span><span class="o">*</span> <span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">pthread_cond_timedwait</span><span class="p">(</span><span class="kt">pthread_cond_t</span><span class="o">*</span> <span class="n">cond</span><span class="p">,</span> <span class="kt">pthread_mutex_t</span><span class="o">*</span> <span class="n">mutex</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">timespec</span><span class="o">*</span> <span class="n">tsptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">pthread_cond_signal</span><span class="p">(</span><span class="kt">pthread_cond_t</span><span class="o">*</span> <span class="n">cond</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">pthread_cond_broadcast</span><span class="p">(</span><span class="kt">pthread_cond_t</span><span class="o">*</span> <span class="n">cond</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="152-条件变量实例">1.5.2 条件变量实例</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">  <span class="mi">1</span> <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">stdio</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="mi">2</span> <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">unistd</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="mi">3</span> <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">pthread</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="mi">4</span> <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">errno</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>                                                                                                            
</span></span><span class="line"><span class="cl">  <span class="mi">5</span>      
</span></span><span class="line"><span class="cl">  <span class="mi">6</span> <span class="kt">int</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="mi">7</span> <span class="kt">pthread_mutex_t</span> <span class="n">m_lock</span> <span class="o">=</span> <span class="n">PTHREAD_MUTEX_INITIALIZER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="mi">8</span> <span class="kt">pthread_cond_t</span>  <span class="n">c_lock</span> <span class="o">=</span> <span class="n">PTHREAD_COND_INITIALIZER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="mi">9</span>      
</span></span><span class="line"><span class="cl"> <span class="mi">10</span> <span class="kt">void</span> <span class="nf">thread_join</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="mi">11</span> <span class="p">{</span>    
</span></span><span class="line"><span class="cl"> <span class="mi">12</span>     <span class="nf">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="mi">13</span>     <span class="k">while</span> <span class="p">(</span><span class="n">done</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="mi">14</span>         <span class="nf">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="mi">15</span>     <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="mi">16</span>     <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="mi">17</span> <span class="p">}</span>    
</span></span><span class="line"><span class="cl"> <span class="mi">18</span>      
</span></span><span class="line"><span class="cl"> <span class="mi">19</span> <span class="kt">void</span> <span class="nf">thread_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="mi">20</span> <span class="p">{</span>    
</span></span><span class="line"><span class="cl"> <span class="mi">21</span>     <span class="nf">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="mi">22</span>     <span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="mi">23</span>     <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;thread end.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="mi">24</span>     <span class="nf">pthread_cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="mi">25</span>     <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="mi">26</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="mi">28</span> <span class="kt">void</span><span class="o">*</span> <span class="nf">t_func</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="mi">29</span> <span class="p">{</span>    
</span></span><span class="line"><span class="cl"> <span class="mi">30</span>     <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;thread is start.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="mi">31</span>     <span class="nf">thread_exit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> <span class="mi">32</span>     <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="mi">33</span> <span class="p">}</span>    
</span></span><span class="line"><span class="cl"> <span class="mi">34</span>      
</span></span><span class="line"><span class="cl"> <span class="mi">35</span> <span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="mi">36</span> <span class="p">{</span>    
</span></span><span class="line"><span class="cl"> <span class="mi">37</span>     <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;parent start.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="mi">38</span>     <span class="kt">pthread_t</span> <span class="n">tid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="mi">39</span>     <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">t_func</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>                                                                       
</span></span><span class="line"><span class="cl"> <span class="mi">40</span>     <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="mi">41</span>         <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;create pthread failed, errno(%d).</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="mi">42</span>     <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="mi">43</span>     <span class="nf">thread_join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> <span class="mi">44</span>      
</span></span><span class="line"><span class="cl"> <span class="mi">45</span>     <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;parent end.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="mi">46</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="mi">47</span> <span class="p">}</span>   
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="16-二进制信号量">1.6 二进制信号量</h2>
<p>二进制信号量也可以用来实现互斥。二进制信号量的作用类似于互斥锁。详细使用方法见进程通信文章中的信号量部分。</p>
<h1 id="2-死锁">2 死锁</h1>
<h2 id="21-死锁的产生">2.1 死锁的产生</h2>
<h2 id="22-死锁检测">2.2 死锁检测</h2>
<h2 id="22-常见死锁">2.2 常见死锁</h2>
<h1 id="3-线程安全函数">3 线程安全函数</h1>
<p>如果一个函数在相同的时间点可以被多个线程安全的调用，则称该函数是线程安全的。</p>
<p>如果一个函数对多个线程来说是可重入的，就说这个函数是线程安全的。</p>
<p>最典型的场景是：使用了静态变量的函数就是线程不安全的函数。因为多个线程调用时，都可以修改该静态变量。</p>
<p>解决方法是：  将静态变量替换为调用者传入，各个线程自己管理自己的变量。</p>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/apue/">APUE</a>
          <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">多线程</a>
          <a href="/tags/%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5/">线程同步</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/linux/apue/interprocess_communication/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">进程间通信的方法</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/algorithm/backtracking_algorithm/">
            <span class="next-text nav-default">回溯算法</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

      </div>
    </main>
    

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:alvincat@126.com" class="iconfont icon-email" title="email"></a>
      <a href="https://www.google.com" class="iconfont icon-google" title="google"></a>
      <a href="https://github.com/alvincat" class="iconfont icon-github" title="github"></a>
      <a href="https://weibo.com" class="iconfont icon-weibo" title="weibo"></a>
      <a href="https://www.zhihu.com" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://www.douban.com" class="iconfont icon-douban" title="douban"></a>
      <a href="https://www.bilibili.com" class="iconfont icon-bilibili" title="bilibili"></a>
  
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2026<span class="heart"><i class="iconfont icon-heart"></i></span><span>alvincat</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
